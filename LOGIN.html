<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <title>എന്റെ രേഖകൾ</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 10px; width: 400px; margin: auto; box-shadow: 0 0 10px #ccc; }
        input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: 1px solid #aaa; }
        button { background: black; color: white; cursor: pointer; }
        button:hover { background: #333; }
        .hidden { display: none; }
        .person-box { background: #eef; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .file-box { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="registerBox" class="box hidden">
    <h2>റജിസ്റ്റർ ചെയ്യുക</h2>
    <input type="text" id="regUser" placeholder="പുതിയ യൂസർ ഐഡി">
    <input type="password" id="regPass" placeholder="പുതിയ പാസ്‍വേഡ്">
    <button onclick="register()">Submit</button>
    <p style="text-align:center;margin-top:10px;cursor:pointer;color:blue" onclick="switchViews('login')">ഇതിനകം റജിസ്റ്റർ ചെയ്തു? ലോഗിൻ ചെയ്യുക</p>
</div>

<div id="loginBox" class="box">
    <h2>ലോഗിൻ ചെയ്യുക</h2>
    <input type="text" id="loginUser" placeholder="യൂസർ ഐഡി">
    <input type="password" id="loginPass" placeholder="പാസ്‍വേഡ്">
    <button onclick="login()">Login</button>
    <p style="text-align:center;margin-top:10px;cursor:pointer;color:blue" onclick="showForgot()">Forgot Password?</p>
    <p style="text-align:center;margin-top:10px;cursor:pointer;color:green" onclick="switchViews('register')">പുതിയ യൂസർ? റജിസ്റ്റർ ചെയ്യുക</p>
</div>

<div id="forgotBox" class="box hidden">
    <h3>Forgot Password</h3>
    <input type="text" id="forgotUser" placeholder="യൂസർ ഐഡി">
    <button onclick="recoverPassword()">Recover</button>
    <p style="text-align:center;margin-top:10px;cursor:pointer;color:blue" onclick="switchViews('login')">ലോഗിൻ സ്ക്രീനിലേക്ക് തിരികെ പോകുക</p>
</div>

<div id="mainApp" class="box hidden">
    <h2>എന്റെ രേഖകൾ</h2>
    <input type="text" id="personName" placeholder="പേര് ചേർക്കുക">
    <button onclick="addPerson()">Add</button>

    <div id="personsList"></div>

    <button style="background:red;margin-top:20px" onclick="logout()">Logout</button>
</div>

<script>
    let currentUser = null;

    // പുതിയ ഫങ്ക്ഷൻ: Login/Register/Forgot സ്ക്രീനുകൾ മാറ്റാനായി
    function switchViews(target) {
        registerBox.classList.add("hidden");
        loginBox.classList.add("hidden");
        forgotBox.classList.add("hidden");

        if (target === 'register') {
            registerBox.classList.remove("hidden");
        } else if (target === 'login') {
            loginBox.classList.remove("hidden");
        } else if (target === 'forgot') {
            forgotBox.classList.remove("hidden");
        }
    }

    function register() {
        let u = regUser.value;
        let p = regPass.value;
        if (!u || !p) return alert("എല്ലാ വിവരങ്ങളും പൂരിപ്പിക്കുക!");
        
        // യൂസർ ഐഡി ഉണ്ടോ എന്ന് പരിശോധിക്കുന്നു
        if (localStorage.getItem("user_" + u)) {
             return alert("ഈ യൂസർ ഐഡി ഇതിനകം ഉണ്ട്. ലോഗിൻ ചെയ്യുക.");
        }

        localStorage.setItem("user_" + u, p);
        localStorage.setItem("data_" + u, JSON.stringify([]));
        alert("Registration Successful!");
        
        // വിജയകരമായി റജിസ്റ്റർ ചെയ്ത ശേഷം Login സ്ക്രീനിലേക്ക് മാറുന്നു
        switchViews('login'); 
    }

    function login() {
        let u = loginUser.value;
        let p = loginPass.value;
        if (localStorage.getItem("user_" + u) === p) {
            currentUser = u;
            loginBox.classList.add("hidden");
            mainApp.classList.remove("hidden");
            loadPersons();
        } else {
            alert("Wrong User or Password!");
        }
    }

    function showForgot() {
        switchViews('forgot');
    }

    function recoverPassword() {
        let u = forgotUser.value;
        let p = localStorage.getItem("user_" + u);
        alert(p ? "Your Password: " + p : "User Not Found");
    }

    function addPerson() {
        let name = personName.value;
        if (!name) return;
        let persons = JSON.parse(localStorage.getItem("data_" + currentUser));
        persons.push({ name: name, files: [] });
        localStorage.setItem("data_" + currentUser, JSON.stringify(persons));
        personName.value = "";
        loadPersons();
    }

    function loadPersons() {
        let persons = JSON.parse(localStorage.getItem("data_" + currentUser));
        personsList.innerHTML = "";
        persons.forEach((p, i) => {
            personsList.innerHTML += `
                <div class="person-box">
                    <b>${p.name}</b>
                    <button onclick="deletePerson(${i})">Delete</button>
                    <input type="file" onchange="uploadFile(event, ${i})">
                    <div>${p.files.map((f, fi) => `
                        <div class='file-box'>
                            <a href="${f.url}" download>${f.name}</a>
                            <button onclick="deleteFile(${i}, ${fi})">Delete</button>
                        </div>
                    `).join('')}</div>
                </div>`;
        });
    }

    function uploadFile(e, index) {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = () => {
            let persons = JSON.parse(localStorage.getItem("data_" + currentUser));
            persons[index].files.push({ name: file.name, url: reader.result });
            localStorage.setItem("data_" + currentUser, JSON.stringify(persons));
            loadPersons();
        };
        reader.readAsDataURL(file);
    }

    function deletePerson(i) {
        let persons = JSON.parse(localStorage.getItem("data_" + currentUser));
        persons.splice(i, 1);
        localStorage.setItem("data_" + currentUser, JSON.stringify(persons));
        loadPersons();
    }

    function deleteFile(pi, fi) {
        let persons = JSON.parse(localStorage.getItem("data_" + currentUser));
        persons[pi].files.splice(fi, 1);
        localStorage.setItem("data_" + currentUser, JSON.stringify(persons));
        loadPersons();
    }

    function logout() {
        currentUser = null;
        mainApp.classList.add("hidden");
        // logout-ന് ശേഷം Login സ്ക്രീൻ കാണിക്കുന്നു
        switchViews('login');
    }
</script>

</body>
</html>